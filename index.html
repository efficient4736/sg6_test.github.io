<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SG6 Sicherheits-Check-in</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: var(--tg-theme-bg-color, #000); color: var(--tg-theme-text-color, #fff) !important; }
        h1 { text-align: center; color: var(--tg-theme-text-color, #fff) !important; }
        ul { list-style: none; padding: 0; }
        li { margin-bottom: 10px; color: var(--tg-theme-text-color, #fff) !important; }
        input[type="checkbox"] { margin-right: 10px; accent-color: var(--tg-theme-button-color, #FF0000); }
    </style>
</head>
<body>
    <h1>Sicherheits-Check-in</h1>
    <ul>
        <li><input type="checkbox" id="brille"> Schutzbrile vorhanden</li>
        <li><input type="checkbox" id="weste"> Schutzweste vorhanden</li>
        <li><input type="checkbox" id="regeln"> Regeln verstanden (Fairness, Trefferzonen)</li>
    </ul>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // BiometricManager initialisieren mit Debugging
        tg.BiometricManager.init((err) => {
            if (err) {
                console.error('Biometric Init failed:', err);
                tg.showAlert('Biometrie-Init fehlgeschlagen: ' + err);
            } else {
                console.log('BiometricManager initialized');
                console.log('isBiometricAvailable:', tg.BiometricManager.isBiometricAvailable);
                console.log('biometricType:', tg.BiometricManager.biometricType);
                console.log('isAccessGranted:', tg.BiometricManager.isAccessGranted);
                if (!tg.BiometricManager.isBiometricAvailable) {
                    tg.showAlert('Biometrie nicht verfügbar auf diesem Gerät.');
                }
            }
        });

        const mainButton = tg.MainButton;
        mainButton.text = 'Check-in Bestätigen';
        mainButton.show();

        mainButton.onClick(() => {
            const checks = [
                document.getElementById('brille').checked,
                document.getElementById('weste').checked,
                document.getElementById('regeln').checked
            ];
            if (checks.every(c => c)) {
                console.log('Alle Checks gesetzt – starte Biometrie-Prozess');
                if (!tg.BiometricManager.isInited) {
                    tg.showAlert('BiometricManager nicht initialisiert.');
                    return;
                }
                if (!tg.BiometricManager.isBiometricAvailable) {
                    tg.showAlert('Biometrie nicht verfügbar – fahre ohne fort.');
                    completeCheckInWithoutBiometric();
                    return;
                }
                if (!tg.BiometricManager.isAccessGranted) {
                    console.log('Requesting access...');
                    tg.BiometricManager.requestAccess({ reason: 'Zur sicheren Bestätigung des Check-ins' }, (granted) => {
                        console.log('Access granted:', granted);
                        if (!granted) {
                            tg.showAlert('Biometrie-Zugriff verweigert.');
                            return;
                        }
                        authenticateCheckIn();
                    });
                } else {
                    authenticateCheckIn();
                }
            } else {
                tg.showAlert('Bitte alle Punkte abhaken!');
            }
        });

        function authenticateCheckIn() {
            console.log('Authenticating...');
            tg.BiometricManager.authenticate({ reason: 'Bestätige deinen Sicherheits-Check-in' }, (success, token) => {
                console.log('Authenticate result:', success, 'Token:', token);
                if (success) {
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.sendData('Sicherheits-Check: Erfolgreich');
                    tg.showAlert('Check-in abgeschlossen – viel Spaß!');
                } else {
                    tg.showAlert('Biometrie-Authentifizierung fehlgeschlagen.');
                }
            });
        }

        function completeCheckInWithoutBiometric() {
            // Fallback ohne Biometrie
            tg.HapticFeedback.notificationOccurred('success');
            tg.sendData('Sicherheits-Check: Erfolgreich (ohne Biometrie)');
            tg.showAlert('Check-in abgeschlossen (Biometrie nicht verfügbar) – viel Spaß!');
        }

        // Event-Handler für Debugging
        tg.onEvent('biometricManagerUpdated', (data) => {
            console.log('Biometric Manager Updated:', data);
        });
        tg.onEvent('biometricAuthRequested', (data) => {
            console.log('Biometric Auth Event:', data);
        });
        tg.onEvent('themeChanged', () => location.reload());
    </script>
</body>
</html>
